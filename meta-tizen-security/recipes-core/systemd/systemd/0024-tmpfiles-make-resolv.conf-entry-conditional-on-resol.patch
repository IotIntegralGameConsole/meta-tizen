From 714d214e217e893128f4ef2512a5e31eda9fcb30 Mon Sep 17 00:00:00 2001
From: Tom Gundersen <teg@jklm.no>
Date: Wed, 27 Aug 2014 17:45:41 +0200
Subject: [PATCH 24/24] tmpfiles: make resolv.conf entry conditional on
 resolved support

Change-Id: Iaad87da2d2b9f3e227b488e2eeb9e43ebbe7212c
Signed-off-by: Sangjung Woo <sangjung.woo@samsung.com>
Origin: http://cgit.freedesktop.org/systemd/systemd/commit/?id=aeb50ff0bd
Bug-Tizen: TC-2406
---
 Makefile.am            | 11 ++++++++---
 TODO                   |  2 --
 tmpfiles.d/etc.conf    | 15 ---------------
 tmpfiles.d/etc.conf.m4 | 17 +++++++++++++++++
 4 files changed, 25 insertions(+), 20 deletions(-)
 delete mode 100644 tmpfiles.d/etc.conf
 create mode 100644 tmpfiles.d/etc.conf.m4

diff --git a/Makefile.am b/Makefile.am
index b0fb1b9..957a95a 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -1934,13 +1934,15 @@ nodist_systemunit_DATA += \
 	units/systemd-tmpfiles-setup.service \
 	units/systemd-tmpfiles-clean.service
 
+nodist_tmpfiles_DATA = \
+    tmpfiles.d/etc.conf
+
 dist_tmpfiles_DATA = \
 	tmpfiles.d/systemd.conf \
 	tmpfiles.d/systemd-nologin.conf \
 	tmpfiles.d/tmp.conf \
 	tmpfiles.d/x11.conf \
-	tmpfiles.d/var.conf \
-	tmpfiles.d/etc.conf
+	tmpfiles.d/var.conf
 
 if HAVE_SYSV_COMPAT
 dist_tmpfiles_DATA += \
@@ -1963,10 +1965,14 @@ INSTALL_DIRS += \
 endif
 
 EXTRA_DIST += \
+	tmpfiles.d/etc.conf.m4 \
 	units/systemd-tmpfiles-setup-dev.service.in \
 	units/systemd-tmpfiles-setup.service.in \
 	units/systemd-tmpfiles-clean.service.in
 
+CLEANFILES += \
+	tmpfiles.d/etc.conf
+
 # ------------------------------------------------------------------------------
 if ENABLE_SYSUSERS
 systemd_sysusers_SOURCES = \
@@ -5707,7 +5713,6 @@ tmpfiles.d/%: tmpfiles.d/%.m4
 	$(AM_V_at)$(MKDIR_P) $(dir $@)
 	$(AM_V_M4)$(M4) -P $(M4_DEFINES) < $< > $@
 
-
 units/%: units/%.m4
 	$(AM_V_at)$(MKDIR_P) $(dir $@)
 	$(AM_V_M4)$(M4) -P $(M4_DEFINES) -DFOR_SYSTEM=1 < $< > $@
diff --git a/TODO b/TODO
index cbd8384..f414f6d 100644
--- a/TODO
+++ b/TODO
@@ -111,8 +111,6 @@ Features:
 
 * Allow multiple ExecStart= for all Type= settings, so that we can cover rescue.service nicely
 
-* the resolv.conf tmpfiles line should be covered by ENABLE_NETWORKD...
-
 * Add a new verb "systemctl top"
 
 * logind: allow users to kill or lock their own sessions
diff --git a/tmpfiles.d/etc.conf b/tmpfiles.d/etc.conf
deleted file mode 100644
index b23272c..0000000
--- a/tmpfiles.d/etc.conf
+++ /dev/null
@@ -1,15 +0,0 @@
-#  This file is part of systemd.
-#
-#  systemd is free software; you can redistribute it and/or modify it
-#  under the terms of the GNU Lesser General Public License as published by
-#  the Free Software Foundation; either version 2.1 of the License, or
-#  (at your option) any later version.
-
-# See tmpfiles.d(5) for details
-
-L /etc/os-release - - - - ../usr/lib/os-release
-L /etc/localtime - - - - ../usr/share/zoneinfo/UTC
-L+ /etc/mtab - - - - ../proc/self/mounts
-L /etc/resolv.conf - - - - ../run/systemd/resolve/resolv.conf
-C /etc/nsswitch.conf - - - -
-C /etc/pam.d - - - -
diff --git a/tmpfiles.d/etc.conf.m4 b/tmpfiles.d/etc.conf.m4
new file mode 100644
index 0000000..f567c8d
--- /dev/null
+++ b/tmpfiles.d/etc.conf.m4
@@ -0,0 +1,17 @@
+#  This file is part of systemd.
+#
+#  systemd is free software; you can redistribute it and/or modify it
+#  under the terms of the GNU Lesser General Public License as published by
+#  the Free Software Foundation; either version 2.1 of the License, or
+#  (at your option) any later version.
+
+# See tmpfiles.d(5) for details
+
+L /etc/os-release - - - - ../usr/lib/os-release
+L /etc/localtime - - - - ../usr/share/zoneinfo/UTC
+L+ /etc/mtab - - - - ../proc/self/mounts
+m4_ifdef(`ENABLE_RESOLVED',
+L /etc/resolv.conf - - - - ../run/systemd/resolve/resolv.conf
+)
+C /etc/nsswitch.conf - - - -
+C /etc/pam.d - - - -
-- 
1.8.4.5

